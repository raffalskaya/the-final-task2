# Распределённый вычислитель арифметических выражений

## Назначение

Данный проект предназначен для вычисления результата арифмитического выражения.

Проект являестся итоговым заданием спринта 2 курса [Программирование
на Go](https://lyceum.yandex.ru/go).

## Описание

Проект представляет собой демонстрацию распределённого веб-сервиса для вычисления результата арифмитического выражения.

Проект состоит из двух компонентов:

Агент — демон, который получает выражение для вычисления с сервера, вычисляет его и отправляет на сервер результат выражения. При старте демон запускает несколько горутин, каждая из которых выступает в роли независимого вычислителя. Количество горутин регулируется переменной среды COMPUTING_POWER. Агент общается с оркестратором по протоколу http. Агент все время приходит к оркестратору с запросом "дай задачку поработать" (в ручку GET internal/task для получения задач). Оркестратор отдаёт задачу. Агент производит вычисление и в ручку оркестратора (POST internal/task для приема результатов обработки данных) отдаёт результат

Оркестратор — сервер, который принимает арифметическое выражение, переводит его в набор последовательных задач и обеспечивает порядок их выполнения.

## Запуск проекта:
Для запуск проекта необходимо (сценарий запуска для linux или macos):
> **Примечание:**  перед запуском убедитесь, что порт 8000 не занят другим приложением

1. Клонировать репозиторий с исходным кодом выполнив команду:
    ```bash
    git clone https://github.com/raffalskaya/the-final-task2.git
    ```
2. Перейти в каталог с проектом оркестратора выполнив команду:
    ```bash
    cd the-final-task2/orchestrator
    ```
3. Запустить оркестратор командой:
    ```bash
    go run .
    ```
4.  Открыть новое окно терминала и перейти в каталог с проектом, клонированного с github
   
5.  Перейти в каталог с проектом агента выполнив команду:
    ```bash
    cd ./agent
    ```
6. Запустить агент командой:
    ```bash
    go run .
    ```

Также проект можно запустить из VSCode. Для этого необходимо открыть клонированный репозиторий в VSCode.
Для запустка оркестратора создана конфигурация "Orchestrator"
Для запустка агента создана конфигурация "Agent"

## Схема взаимодействия системы
> **Примечание:**  более подробная схема находится в каталоге docs

```text
* - - - - - - - *                 * - - - - - - - *
|  оркестратор  | ---- задача---->|     агент     |
* - - - - - - - *                 * - - - - - - - *
        ^
    выражение
        |
* - - - - - - - *
|  пользователь |
* - - - - - - - *

```

## Сценарий использования

Пользователь отправляет арифметическое выражение по протоколу HTTP в оркестратор на вычисление. Для получения запросов на вычисление от пользователя в оркестраторе реализован endpoint /api/v1/calculate.

```json
Коды ответа: 
201 - выражение принято для вычисления
422 - невалидные данные
500 - что-то пошло не так
```
Для отправки запроса на вычисление необходимо выполнить команду:
```bash
    curl --location 'localhost:8000/api/v1/calculate' --header 'Content-Type: application/json' --data '{"expression": "4+3*2"}'
```
В ответе вы должны получить 
```json
{
    "id": <уникальный идентификатор выражения>
}
```

Далее агент запрашивает у оркестратора задачу на вычисление по GET endpoint /internal/task

```text
Коды ответа: 
200 - успешно получена задача
404 - нет задачи
500 - что-то пошло не так
```
В ответе агент должны получить:

```json
{
    "task":
        {
            "id": <идентификатор задачи>,
            "arg1": <значение первого аргумента>,
            "arg2": <значение второго аргумента>,
            "operation": <операция>,
            "operation_time": <время выполнения операции>
        }
}
```

Вы тоже можете попробовать получить задачу из терминала выполнив команду:
> **Примечание:**  не забудте остановить агента перед получением задачи и добавить выражение на вычисление в оркестратор

```bash
    curl --location 'localhost:8000/api/internal/task'
```

В ответ вам должна вернуться задача на вычисление как описано выше. Если вы не вычислите задачу за определённое время, то эта задача вернётся в список задач для вычеслений.

Время выполнения операций задается переменными среды в миллисекундах
```text
TIME_ADDITION_MS - время выполнения операции сложения в миллисекундах
TIME_SUBTRACTION_MS - время выполнения операции вычитания в миллисекундах
TIME_MULTIPLICATIONS_MS - время выполнения операции умножения в миллисекундах
TIME_DIVISIONS_MS - время выполнения операции деления в миллисекундах
```

После вычисления результата задачи агент отправляет POST запрос на endpoint оркестратора /internal/task в следущем формате:
```json
{
  "id":  <идентификатор задачи>,
  "result":  <результат задачи>
}
```
```text
Коды ответа: 
200 - успешно записан результат
404 - нет такой задачи
422 - невалидные данные
500 - что-то пошло не так
```

Вы тоже можете попробовать отправить результат задачи оркестратору из терминала выполнив команду:
> **Примечание:**  не забудте заменить поля <идентификатор задачи> и <результат задачи> на соответсвующие значения

```bash
    curl --location 'localhost:8000/api/internal/task' --header 'Content-Type: application/json' --data '{"id": <идентификатор задачи>, "result": <результат задачи>}'
```

В ответ вам должно вернуться пустое сообщение с кодом ответа, описанном выше.

Также у пользователя есть возможность посмотреть все выражения отправленные оркестратору на вычисление. Для этого реализован endpoint /api/v1/expressions

```text
Коды ответа:
200 - успешно получен список выражений
500 - что-то пошло не так
```

Для получения списка выражений необходимо выполнить следующую команду:

```bash
curl --location 'localhost:8000/api/v1/expressions'
```

В ответ вам вернётся список выражений следующей структуры:

```json
{
    "expressions": [
        {
            "id": <идентификатор выражения>,
            "status": <статус вычисления выражения>,
            "result": <результат выражения>
        },
        {
            "id": <идентификатор выражения>,
            "status": <статус вычисления выражения>,
            "result": <результат выражения>
        }
    ]
}
```
Также у пользователя есть возможность посмотреть конкретное выражение отправленое оркестратору на вычисление. Для этого реализован endpoint /api/v1/expressions/:id

```text
Коды ответа:
200 - успешно получено выражение
404 - нет такого выражения
500 - что-то пошло не так
```
Для получения конкретного выражения необходимо выполнить следующую команду:
> **Примечание:**  не забудте заменить поле <идентификатор выражения> на соответсвующее значение

```bash
curl --location 'localhost:8000/api/v1/expressions/<идентификатор выражения>'
```

В ответ вам вернётся выражение следующей структуры:

```json
{
    "expression":
        {
            "id": <идентификатор выражения>,
            "status": <статус вычисления выражения>,
            "result": <результат выражения>
        }
}
```